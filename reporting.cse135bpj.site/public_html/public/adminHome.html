<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home</title>
  <script>
    var value = Math.floor(Math.random() * 1000000000000);
    if(typeof document.cookie.split('; ').find(row => row.startsWith('user=')) === 'undefined' || document.cookie.split('; ').find(row => row.startsWith('user='))[0] != "u") {
      document.cookie = "user=" + value;
    }
  </script>
  <script src ='https://cse135bpj.site/collector.js'></script>
  <script src="https://cdn.zingchart.com/zingchart.min.js"></script>

  <style type="text/css">
    #testCSS {width: 3px;}
    #testImg {display: none;}
    #tracker {display: none;}
  </style>

  <style>
    .wrapper{
      display:grid;
      grid-template-columns: auto auto auto auto;
      padding: 10px;
    }
    
    .wrapper > .gridCell{
      background:#1E90FF;
      border: 1px solid rgba(0, 0, 0, 0.8);
      padding: 20px;
      font-size: 20px;
      text-align: center;
    }
  
    .wrapper > .gridCell:nth-child(odd){
      background:#00FFFF;
    }
  </style>
</head>

<body>

  <div id="testCSS"></div>

  <img id="testImg" src="https://cse135bpj.site/favicon.ico">

  <h1>Admin Home Page</h1>
  <a href="/authapp/users">Link to Users</a>
  <br>
  <br>
  <button onclick="document.location='/authapp/logout'">Logout</button>

  <script>
    fetch('https://cse135bpj.site/api/activity')
      .then(response => response.json())
      .then(data => {

        var numPageViews = 0;

        for (var i = 0; i < data.length; i++) {
          for (var j = 0; j < JSON.parse(data[i].Metrics).length; j++) {
            numPageViews += JSON.parse(data[i].Metrics)[j].PageViews;
          }
        }

        var avgSessionDuration = 0;

        for (var i = 0; i < data.length; i++) {
          if(data[i].UserLeave != "" && data[i].UserEnter != "" ) {
            avgSessionDuration += (data[i].UserLeave - data[i].UserEnter) / 1000;
          }
        }

        d = avgSessionDuration / data.length;

        var h = Math.floor(d / 3600);
        var m = Math.floor(d % 3600 / 60);
        var s = Math.floor(d % 3600 % 60);

        var hDisplay = h > 0 ? (h > 9 ? h + ":" : "0" + h + ":") : "00:";
        var mDisplay = m > 0 ? (m > 9 ? m + ":" : "0" + m + ":") : "00:";
        var sDisplay = s > 0 ? (s > 9 ? s : "0" + s) : "00";

        var sessions = 0;

        for (var i = 0; i < data.length; i++) {
          sessions += data[i].Sessions;
        }


        var bounced = 0;

        for (var i = 0; i < data.length; i++) {
          if (data[i].Sessions === 1) {
            bounced += 1;
          }
        }

        fetch('https://cse135bpj.site/api/static')
        .then(response => response.json())
        .then(data => {

          var uniqueVisitors = 0;
          var totalVisitors = data.length;

          for (var i = 0; i < data.length; i++) {
            if (data[i].UniqueVisitor == 1) {
              uniqueVisitors += 1;
            }
          }

          document.getElementById('UniqueVisitors').innerHTML = uniqueVisitors;
          document.getElementById('TotalVisitors').innerHTML = totalVisitors;
          document.getElementById('SessionsPerUser').innerHTML = (sessions / totalVisitors).toFixed(2);
          document.getElementById('BounceRate').innerHTML = ((bounced / totalVisitors) * 100).toFixed(2) + "%";
        })
        .catch((error) => {
          console.error("Error:", error);
        });

        document.getElementById('Pageviews').innerHTML = numPageViews;
        document.getElementById('AvgSessDur').innerHTML = hDisplay + mDisplay + sDisplay;
        document.getElementById('NumSessions').innerHTML = sessions;
        document.getElementById('PagesPerSession').innerHTML = (numPageViews / sessions).toFixed(2);
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  </script>


<script>

  var morning = 0;
  var afternoon = 1;
  var evening = 2;
  var night = 3;
  var midnight = 4;
  var activeArr = [0, 0, 0, 0, 0];
  var inactiveArr = [0, 0, 0, 0, 0];
  var lineArr = [0, 0, 0, 0 , 0];

  fetch('https://cse135bpj.site/api/activity')
      .then(response => response.json())
      .then(activityData => {

        fetch('https://cse135bpj.site/api/static')
          .then(response => response.json())
          .then(staticData => {

            for (var i = 0; i < activityData.length; i++) {
              var times = activityData[i].BreakTime.split(",");
              var max = 0;
              for (j = 0; j < times.length; j++) {
                if(parseInt(times[j]) > max) {
                  max = parseInt(times[j]);
                }
              }
              

              var time = staticData[i].LoadDateObject;
              var ind = -1;
              var hour = 0
              if(time.indexOf("PM") == -1) {
                ind = time.indexOf("AM");
                hour = parseInt(time.substring(ind - 9, ind - 7));
            
              }else {
                ind = time.indexOf("PM")
                hour = parseInt(time.substring(ind - 9, ind - 7));
                hour = hour + 12;
              }

              
              if(hour > 6 && hour < 12) {
                lineArr[morning] += 1;
              } else if (hour > 12 && hour < 17) {
                lineArr[afternoon] += 1;
              } else if (hour > 17 && hour < 21) {
                lineArr[evening] += 1;
              } else if(hour > 21 && hour <= 23) {
                lineArr[night] += 1;
              } else {
                lineArr[midnight] += 1
              }

              if(max < 600000) {
                if(hour > 6 && hour < 12) {
                  activeArr[morning] += 1;
                } else if (hour > 12 && hour < 17) {
                  activeArr[afternoon] += 1;
                } else if (hour > 17 && hour < 21) {
                  activeArr[evening] += 1;
                } else if(hour > 21 && hour <= 23) {
                  activeArr[night] += 1;
                } else {
                  activeArr[midnight] += 1
                }
              }else {
                if(hour > 6 && hour < 12) {
                  inactiveArr[morning] += 1;
                } else if (hour > 12 && hour < 17) {
                  inactiveArr[afternoon] += 1;
                } else if (hour > 17 && hour < 21) {
                  inactiveArr[evening] += 1;
                } else if(hour > 21 && hour <= 23) {
                  inactiveArr[night] += 1;
                } else {
                  inactiveArr[midnight] += 1
                }

              }

            }

            zingchart.render({
            id: 'lineChart',
            data: {
              type: 'line',
              height: "100%",
              width: "90%",
              x: "5%",
          
                "legend": {
                "layout": "x3",
                  "overflow": "page",
                  "alpha": 0.05,
                  "shadow": false,
                  "align": "center",
                  "adjust-layout": true,
                  "marker": {
                    "type": "circle",
                    "border-color": "none",
                    "size": "10px"
                  },
                  "border-width": 0,
                  "maxItems": 3,
                  "toggle-action": "hide",
                  "pageOn": {
                    "backgroundColor": "#000",
                    "size": "10px",
                    "alpha": 0.65
                  },
                  "pageOff": {
                    "backgroundColor": "#7E7E7E",
                    "size": "10px",
                    "alpha": 0.65
                  },
                  "pageStatus": {
                    "color": "black"
                  }
                },
                "scale-x": {
                  "label": {
                    "text": "Different Tines of Day",
                  },
                    "labels": [
                      "Morning (6AM-12PM)",
                      "Afternoon (12PM - 5PM)",
                      "Evening (5PM - 9PM)",
                      "Night (9PM - 12AM)",
                      "Midnight (12AM - 6AM)"
                    ]
                  },
                  "scale-y": {
                    "label": {
                      "text": "Number of Users",
                    },
                  },
                  series: [
                    { values: lineArr,
                      text: "Total Users"}, 
                      { values: inactiveArr,
                      text: "Less Active Users"}, 
                      { values: activeArr,
                      text: "Active Users"}, 
                  ]
                }
              });

            

          })
        .catch((error) => {
          console.error("Error:", error);
        });


    })
    .catch((error) => {
      console.error("Error:", error);
    });    

</script>






  <h1 style="text-align:center"> Analytical Data </h1>
  <h2 style="text-align:center">Grid</h2>
  <div style="text-align:center">
    <a href="/authapp/reports">Generate Report</a>
  </div>
  <div class="wrapper">
    <div class="gridCell"><b>Total Users</b> <p id="TotalVisitors"></p> </div>
    <div class="gridCell"><b>Unique Users</b> <p id="UniqueVisitors"></p> </div>
    <div class="gridCell"><b>Sessions</b> <p id="NumSessions"></p> </div>
    <div class="gridCell"><b>Number of Sessions per User</b> <p id="SessionsPerUser"></p> </div>
    <div class="gridCell"><b>Pageviews</b> <p id="Pageviews"></p> </div>
    <div class="gridCell"><b>Pages / session</b> <p id="PagesPerSession"></p></div>
    <div class="gridCell"><b>Avg. session duration</b> <p id="AvgSessDur"></p> </div>
    <div class="gridCell"><b>Bounce Rate</b> <p id="BounceRate"></p> </div>
  </div>



  <h2 style="text-align:center"> Chart 1 </h2>
  <div id="lineChart"></div>
  <h2 style="text-align:center"> Chart 2 </h2>
  <div id="barChart"></div>
  <h2 style="text-align:center"> Grid </h2>
  <div id="pieChart"></div>


  <script src="https://cdn.zingchart.com/zingchart.min.js"></script>


  <!-- <?php
    /* Open connection to "zing_db" MySQL database. */
    $mysqliData = new mysqli("localhost", "root", "cse135Password", "hw3");
  
    /* Check the connection. */
    if (mysqli_connect_errno()) {
        printf("Connect failed: %s\n", mysqli_connect_error());
        exit();
    }
    /* Fetch result set from t_test table */
    $pieData = mysqli_query($mysqliData, "SELECT SUM(MouseLeft), SUM(MouseMiddle), SUM(MouseRight) FROM activity");
    $barData = mysqli_query($mysqliData, "SELECT COUNT(id), SUM(CASE WHEN UserCookie  THEN 1 ELSE 0 END), SUM(CASE WHEN UserJS  THEN 1 ELSE 0 END), 
    SUM(CASE WHEN UserImages  THEN 1 ELSE 0 END), SUM(CASE WHEN UserCSS  THEN 1 ELSE 0 END) FROM static");
    $lineData = mysqli_query($mysqliData, "SELECT CursorXPos, CursorYPos, Scrolling from activity");
  ?> -->
  
  <script>
  
  fetch('https://cse135bpj.site/api/activity')
  .then(response => response.json())
  .then(data => {
  
    var mouseLeft = 0;
    var mouseMiddle = 0;
    var mouseRight = 0;
  
    for(var i = 0; i < data.length; i++) {
      mouseLeft += data[i].MouseLeft;
      mouseMiddle += data[i].MouseMiddle;
      mouseRight += data[i].MouseRight;
    }
  
    zingchart.render({
        id: 'pieChart',
        data: {
        "type": "pie3d",
   
        "plot": {
          //Use the "slice" attribute to adjust the size of the donut ring.
        },
        "series": [{
            values: [mouseLeft],
            text: 'Mouse Left Click'
          },
          {
            values: [mouseRight],
            text: 'Mouse Right Click'
          },
          {
            values: [mouseMiddle],
            text: 'Mouse Middle Click'
          },
        ]
      }
  
    });
  })
  .catch((error) => {
    console.error("Error:", error);
  });
  


  
  // ////  ***********     PARSE BAR CHART DATA     ********/////////////
  // var trues = [];
  // var falses = [];
  // var total =[
  //   "<?php while($info=mysqli_fetch_array($barData)) echo $info[ 'COUNT(id)' ]; ?>"
  //   ];
  //   total = parseInt(total[0]);
   
  // "<?php  $barData = mysqli_query($mysqliData, 'SELECT COUNT(id), SUM(CASE WHEN UserCookie  THEN 1 ELSE 0 END), count(CASE WHEN UserJS  THEN 1 ELSE 0 END), count(CASE WHEN UserImages  THEN 1 ELSE 0 END), count(CASE WHEN UserCSS  THEN 1 ELSE 0 END) FROM static') ?>"
  
  // var cookie =[
  //   "<?php while($info=mysqli_fetch_array($barData)) echo $info[ 'SUM(CASE WHEN UserCookie  THEN 1 ELSE 0 END)' ]; ?>"
  //   ];
  // cookie = parseInt(cookie[0]);
  // trues.push(cookie);
  // falses.push(total - cookie);
  
  // "<?php  $barData = mysqli_query($mysqliData, 'SELECT COUNT(id), SUM(CASE WHEN UserCookie THEN 1 ELSE 0 END), SUM(CASE WHEN UserJS THEN 1 ELSE 0 END), SUM(CASE WHEN UserImages THEN 1 ELSE 0 END), SUM(CASE WHEN UserCSS THEN 1 ELSE 0 END) FROM static') ?>"
  
  // var js =[
  //   "<?php while($info=mysqli_fetch_array($barData)) echo $info[ 'SUM(CASE WHEN UserJS THEN 1 ELSE 0 END)' ]; ?>"
  //   ];
  // js = parseInt(js[0]);
  // trues.push(js);
  // falses.push(total - js);
  
  // "<?php  $barData = mysqli_query($mysqliData, 'SELECT COUNT(id), SUM(CASE WHEN UserCookie THEN 1 ELSE 0 END), SUM(CASE WHEN UserJS THEN 1 ELSE 0 END), SUM(CASE WHEN UserImages THEN 1 ELSE 0 END), SUM(CASE WHEN UserCSS THEN 1 ELSE 0 END) FROM static') ?>"
  
  // var images =[
  //   "<?php while($info=mysqli_fetch_array($barData)) echo $info[ 'SUM(CASE WHEN UserImages THEN 1 ELSE 0 END)' ]; ?>"
  //   ];
  // images = parseInt(images[0]);
  // trues.push(images);
  // falses.push(total - images);
  
  // "<?php  $barData = mysqli_query($mysqliData, 'SELECT COUNT(id), SUM(CASE WHEN UserCookie THEN 1 ELSE 0 END), SUM(CASE WHEN UserJS THEN 1 ELSE 0 END), SUM(CASE WHEN UserImages THEN 1 ELSE 0 END), SUM(CASE WHEN UserCSS THEN 1 ELSE 0 END) FROM static') ?>"
  
  // var css =[
  //   "<?php while($info=mysqli_fetch_array($barData)) echo $info[ 'SUM(CASE WHEN UserImages THEN 1 ELSE 0 END)' ]; ?>"
  //   ];
  // css = parseInt(css[0]);
  // trues.push(css);
  // falses.push(total - css);
  
  // ////// *************     PARSE LINE CHART DATA       ***********  /////////////////
  // var xPos = [
  //   "<?php while($info=mysqli_fetch_array($lineData)) echo $info[ 'CursorXPos' ].' '; ?>"
  //   ];
  // xPos = xPos[0]
  // xPos = xPos.split(" ")
  // xPos.length = xPos.length - 1;
  // xPos = xPos.map(Number);
  
  // "<?php $lineData = mysqli_query($mysqliData, 'SELECT CursorXPos, CursorYPos, Scrolling from activity'); ?>"
  
  // var yPos = [
  //   "<?php while($info=mysqli_fetch_array($lineData)) echo $info[ 'CursorYPos' ].' '; ?>"
  //   ];
  // yPos = yPos[0]
  // yPos = yPos.split(" ")
  // yPos.length = yPos.length - 1;
  // yPos = yPos.map(Number);
  
  // "<?php $lineData = mysqli_query($mysqliData, 'SELECT CursorXPos, CursorYPos, Scrolling from activity'); ?>"
  
  // var scroll = [
  //   "<?php while($info=mysqli_fetch_array($lineData)) echo $info[ 'Scrolling' ].' '; ?>"
  //   ];
  // scroll = scroll[0]
  // scroll = scroll.split(" ")
  // scroll.length = scroll.length - 1;
  // scroll = scroll.map(Number);
  
  // ////// ************ RENDERING ******////////
  
  // //Bar Chart
  
  // zingchart.render({
  //   id: 'barChart',
  //   data: {
  //   type: "bar",
  
  
    
  //   "scaleX": {
  //           "values": [
  //             "User Cookies",
  //             "User JS",
  //             "User Images",
  //             "User CSS"
  //           ]},
  
  
  //         "legend": {
  //           "layout": "x3",
  //           "overflow": "page",
  //           "alpha": 0.05,
  //           "shadow": false,
  //           "align": "center",
  //           "adjust-layout": true,
  //           "marker": {
  //             "type": "circle",
  //             "border-color": "none",
  //             "size": "10px"
  //           },
  //           "border-width": 0,
  //           "maxItems": 3,
  //           "toggle-action": "hide",
  //           "pageOn": {
  //             "backgroundColor": "#000",
  //             "size": "10px",
  //             "alpha": 0.65
  //           },
  //           "pageOff": {
  //             "backgroundColor": "#7E7E7E",
  //             "size": "10px",
  //             "alpha": 0.65
  //           },
  //           "pageStatus": {
  //             "color": "black"
  //           }
  //         },
  //   series: [{
  //       values: trues,
  //       text: "True",
  //     },
  //     {
  //       values: falses,
  //       text: "False",
  
  //     },
  //   ]
    
  //   }
  // });
  
  // zingchart.render({
  //     id: 'lineChart',
  //     data: {
  //       type: 'line',
  // 	            "legend": {
  //           "layout": "x3",
  //           "overflow": "page",
  //           "alpha": 0.05,
  //           "shadow": false,
  //           "align": "center",
  //           "adjust-layout": true,
  //           "marker": {
  //             "type": "circle",
  //             "border-color": "none",
  //             "size": "10px"
  //           },
  //           "border-width": 0,
  //           "maxItems": 3,
  //           "toggle-action": "hide",
  //           "pageOn": {
  //             "backgroundColor": "#000",
  //             "size": "10px",
  //             "alpha": 0.65
  //           },
  //           "pageOff": {
  //             "backgroundColor": "#7E7E7E",
  //             "size": "10px",
  //             "alpha": 0.65
  //           },
  //           "pageStatus": {
  //             "color": "black"
  //           }
  //         },
  //       series: [
  //         { values: xPos,
  // 	text: "Cursor X Coor"},
  //         { values: yPos,
  // 	text: "Cursor Y Coor"},
  //         { values: scroll,
  // 	text: "Scroll Offset"}
  //       ]
  //     }
  //   });
  
  </script>





</body>

</html>
